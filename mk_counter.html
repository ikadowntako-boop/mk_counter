<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>MK Lounge é›†è¨ˆæ©Ÿ</title>
<style>
  body{font-family:sans-serif;margin:16px;}
  table{border-collapse:collapse;}
  th,td{border:1px solid #ccc;padding:4px 8px;text-align:center;}
  .left{text-align:left;}
  .dup{background:#fdd;}
  .muted{color:#666;font-size:12px;}
  .scroll-wrap{overflow:auto;}
  .result-row{display:flex;justify-content:space-between;margin-bottom:4px;}
</style>
</head>
<body>
<div class="container">
  <h1>MK Lounge é›†è¨ˆæ©Ÿ v6ï¼ˆ12äººå›ºå®šãƒ»12ãƒ¬ãƒ¼ã‚¹ï¼‰</h1>
  <div class="controls">
    <div style="display:flex;align-items:center;gap:8px">
      <button id="regen">è¡¨ã‚’ç”Ÿæˆ</button>
      <button id="clear">è¡¨ã®å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      <button id="resetTags">ã‚¿ã‚°ã ã‘ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div class="muted">
    æ“ä½œ: å·¦ã«ãƒãƒ¼ãƒ ã‚¿ã‚°å…¥åŠ›ã€å³ã®é †ä½è¡¨ã«æ•°å­—ã‚­ãƒ¼ã§é †ä½ã‚’å…¥åŠ›ã€‚<br>
    Enterã§æ¬¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»æœ€ä¸‹è¡Œã§æ¬¡ã®ãƒ¬ãƒ¼ã‚¹ã«ç§»å‹•ã€‚é‡è¤‡ã¯èµ¤èƒŒæ™¯ã§è­¦å‘Šã€‚<br>
    Backspaceã§å‰ã‚»ãƒ«ã«ç§»å‹•ï¼ˆPlayer12â†’Player1â†’æ¬¡åˆ—ï¼‰ã€Deleteã§ã‚»ãƒ«å‰Šé™¤ã€‚
  </div>

  <div class="scroll-wrap" style="display:flex;gap:16px;">
    <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒãƒ¼ãƒ ã‚¿ã‚° -->
    <div id="teamColumn" style="flex-shrink:0;">
      <table id="teamTable">
        <thead><tr><th>ç•ªå·</th><th>ãƒãƒ¼ãƒ ã‚¿ã‚°</th></tr></thead>
        <tbody id="teamBody"></tbody>
      </table>
    </div>

    <!-- å³ã‚«ãƒ©ãƒ ï¼šé †ä½è¡¨ -->
    <div id="rankColumn" style="overflow-x:auto;">
      <table id="mainTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="results">
    <h2 style="font-size:16px;margin:8px 0">é›†è¨ˆçµæœï¼ˆåˆè¨ˆã®ã¿ï¼‰</h2>
    <div id="resultsList" aria-live="polite"></div>
    <div class="actions">
      <button id="copyTotals" class="small">åˆè¨ˆã ã‘ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button id="exportCsv" class="small">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨ã‚»ãƒ«ï¼‰</button>
    </div>
  </div>
</div>

<script>
const RACES = 12;
const PLAYERS = 12;
const points12 = {1:15,2:12,3:10,4:9,5:8,6:7,7:6,8:5,9:4,10:3,11:2,12:1};

const regenBtn = document.getElementById('regen');
const clearBtn = document.getElementById('clear');
const resetTagsBtn = document.getElementById('resetTags');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const teamBody = document.getElementById('teamBody');
const resultsList = document.getElementById('resultsList');
const copyTotalsBtn = document.getElementById('copyTotals');
const exportCsvBtn = document.getElementById('exportCsv');

function createTable(){
  teamBody.innerHTML='';
  for(let i=1;i<=PLAYERS;i++){
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>Player${i}</td><td><input class="teamTag team-input" placeholder="ä¾‹:A" /></td>`;
    teamBody.appendChild(tr);
  }

  thead.innerHTML='';
  const trHead = document.createElement('tr');
  trHead.innerHTML='<th class="left">ç•ªå·</th>';
  for(let r=1;r<=RACES;r++) trHead.innerHTML+=`<th>R${r}</th>`;
  trHead.innerHTML+='<th>åˆè¨ˆ</th>';
  thead.appendChild(trHead);

  tbody.innerHTML='';
  for(let i=1;i<=PLAYERS;i++){
    const tr = document.createElement('tr');
    let html = `<td>Player${i}</td>`;
    for(let r=1;r<=RACES;r++){
      html+=`<td><input class="rankInput" type="number" min="1" max="${PLAYERS}" /></td>`;
    }
    html+=`<td class="totalCell">0</td>`;
    tr.innerHTML=html;
    tbody.appendChild(tr);
  }

  attachInputHandlers();
  computeAll();
}

function attachInputHandlers(){
  const rankInputs = Array.from(document.querySelectorAll('.rankInput'));
  rankInputs.forEach((inp)=>{
    inp.addEventListener('keydown', onRankKeyDown);
    inp.addEventListener('input', computeAll);
  });
  document.querySelectorAll('.teamTag').forEach(ti=>ti.addEventListener('input', computeAll));
}

function onRankKeyDown(e){
  const el = e.target;
  if(!el.classList.contains('rankInput')) return;

  const inputs = Array.from(document.querySelectorAll('.rankInput'));
  const idx = inputs.indexOf(el);
  const row = Math.floor(idx / RACES);
  const col = idx % RACES;

  if(e.key==='Enter'){
    e.preventDefault();
    let nextRow = row+1, nextCol = col;
    if(nextRow>=PLAYERS){ nextRow=0; nextCol=col+1; if(nextCol>=RACES){ nextCol=col; nextRow=row; } }
    inputs[nextRow*RACES+nextCol].focus();
  }

  // Backspace: å‰ã‚»ãƒ«ã«ç§»å‹•ï¼ˆåˆ—å„ªå…ˆâ†’è¡Œé€†é †ï¼‰
  if(e.key==='Backspace'){
    e.preventDefault();
    let prevRow = row-1;
    let prevCol = col;
    if(prevRow<0){ prevRow=PLAYERS-1; prevCol=col-1; if(prevCol<0) prevCol=0; }
    inputs[prevRow*RACES+prevCol].focus();
  }

  // Delete: ç¾ã‚»ãƒ«å‰Šé™¤
  if(e.key==='Delete'){ e.preventDefault(); el.value=''; computeAll(); }
}

function getPointForRank(r){ r=Number(r); return points12[r]||0; }

function computeAll(){
  const rows = Array.from(tbody.querySelectorAll('tr'));
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  for(let c=0;c<RACES;c++){
    const colVals={};
    rows.forEach(row=>{
      const inp = row.querySelectorAll('.rankInput')[c];
      const v = inp.value;
      if(v!==''){ if(!colVals[v]) colVals[v]=[]; colVals[v].push(inp); }
    });
    Object.keys(colVals).forEach(k=>{
      if(colVals[k].length>1) colVals[k].forEach(i=>i.classList.add('dup'));
      else colVals[k].forEach(i=>i.classList.remove('dup'));
    });
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›†è¨ˆ
  const playerTotals=[];
  rows.forEach((row,rIdx)=>{
    const tag = document.querySelectorAll('.teamTag')[rIdx].value.trim();
    const rankInputs = Array.from(row.querySelectorAll('.rankInput'));
    let sum=0; rankInputs.forEach(inp=>sum+=getPointForRank(inp.value));
    row.querySelector('.totalCell').textContent=sum;
    playerTotals.push({player:`Player${rIdx+1}`,tag,points:sum});
  });

  // ãƒãƒ¼ãƒ é›†è¨ˆ
  const teamMap={};
  playerTotals.forEach(p=>{
    if(!p.tag) return;
    if(!teamMap[p.tag]) teamMap[p.tag]={points:0,members:0};
    teamMap[p.tag].points+=p.points;
    teamMap[p.tag].members+=1;
  });

  const teams = Object.keys(teamMap).map(tag=>({tag,points:teamMap[tag].points,members:teamMap[tag].members}));
  teams.sort((a,b)=>b.points-a.points || a.tag.localeCompare(b.tag));

  const top = teams.length>0 ? teams[0].points : 0;
  resultsList.innerHTML='';
  if(teams.length===0){
    resultsList.innerHTML='<div class="muted">ãƒãƒ¼ãƒ ã‚¿ã‚°ã‚’å…¥åŠ›ã™ã‚‹ã¨é›†è¨ˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>';
    return;
  }
  teams.forEach((t,idx)=>{
    const diff = t.points-top; const sign = diff>=0?'+':'';
    const div=document.createElement('div');
    div.className='result-row';
    div.innerHTML=`<div><strong>${idx===0?'ğŸ¥‡ ':''}${t.tag}</strong> <span class="muted">(members:${t.members})</span></div>
      <div>${t.points}ç‚¹ <span class="muted">(${sign}${diff})</span></div>`;
    resultsList.appendChild(div);
  });
}

// copy totals
copyTotalsBtn.addEventListener('click', async ()=>{
  const rows = Array.from(resultsList.querySelectorAll('.result-row'));
  if(rows.length===0){ alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const lines = rows.map((r,idx)=>{
    const tag = r.children[0].querySelector('strong').textContent.replace('ğŸ¥‡ ','');
    const ptsText = r.children[1].textContent.trim();
    const ptsMatch = ptsText.match(/(\d+)ç‚¹.*\((.*)\)/);
    const pts = ptsMatch?ptsMatch[1]:'0';
    const diff = ptsMatch?ptsMatch[2]:'+0';
    const ord = idx===0?'1st':idx===1?'2nd':idx===2?'3rd':`${idx+1}th`;
    return `${ord} ${tag} ${pts} (${diff})`;
  });
  const text = lines.join('\n');
  try{ await navigator.clipboard.writeText(text); alert('åˆè¨ˆã ã‘ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
  catch(e){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('ã‚³ãƒ”ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ã—ã¾ã—ãŸ'); }
});

// CSV export
exportCsvBtn.addEventListener('click', ()=>{
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const headers=['player']; for(let r=1;r<=RACES;r++) headers.push('R'+r); headers.push('total');
  const lines=[headers.join(',')];
  rows.forEach((row,idx)=>{
    const player=`Player${idx+1}`;
    const ranks=Array.from(row.querySelectorAll('.rankInput')).map(i=>i.value||'');
    const totalPts=row.querySelector('.totalCell').textContent;
    lines.push([player,...ranks,totalPts].join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='mk_lounge_full.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

regenBtn.addEventListener('click', createTable);
clearBtn.addEventListener('click', ()=>{
  document.querySelectorAll('.teamTag').forEach(i=>i.value='');
  document.querySelectorAll('.rankInput').forEach(i=>i.value='');
  computeAll();
});
resetTagsBtn.addEventListener('click', ()=>{ document.querySelectorAll('.teamTag').forEach(i=>i.value=''); computeAll(); });

// åˆæœŸç”Ÿæˆ
createTable();
</script>
</body>
</html>
